import os
from pathlib import Path
import json 
import matplotlib.pyplot as plt
import numpy as np
import cv2
from PIL import Image
from tqdm import tqdm

datadir = Path('./data/dnerf/data/')
scene = 'trex'
DEBUG = False
mean = 0
sigma = 25


datadir = datadir / scene

# We only want to add noise to the training dataset
traindir = datadir /'train'
destination = datadir / 'train_noisy_'

# Simple checks
if os.path.exists(destination):
    raise ValueError(f'Destination folder already exists - delete/rename before rerunning')

if not os.path.exists(datadir/'train'):
    raise ValueError('Input Folder does not exists')

if not os.path.exists(traindir):
    raise ValueError('Missing train dir with images')


def noise(img, mean, sigma):
    img = np.asarray(img, dtype=np.float64) #.astype(np.float64)
    gaussian = np.random.normal(mean, sigma, (img.shape[0],img.shape[1], 4)) 
    dst = img + gaussian
    dst = np.clip(dst, 0, 255).astype(np.uint8)
    return Image.fromarray((dst))


os.mkdir(destination)
images = os.listdir(traindir)

with tqdm(total=len(images), unit='image', desc='Processing') as pbar:
    for imfp in images:
        im = Image.open(traindir/imfp)
        dest = destination / imfp
        noisy_im = noise(im, mean, sigma)
        
        if DEBUG:
            noisy_im.show()
            exit()

        noisy_im.save(dest)
        pbar.update(1)
    
